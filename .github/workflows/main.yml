name: Discord Bot

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # 6æ™‚é–“ã”ã¨ã«ãƒã‚§ãƒƒã‚¯

jobs:
  run-bot:
    runs-on: ubuntu-latest
    
    # åŒã˜ã‚³ãƒŸãƒƒãƒˆã«å¯¾ã—ã¦åŒæ™‚ã«è¤‡æ•°ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå®Ÿè¡Œã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹
    concurrency: 
      group: bot-${{ github.ref }}
      cancel-in-progress: true
    
    steps:
    - uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Setup database directory
      run: |
        mkdir -p data
        chmod 755 data
    
    - name: Pull latest database
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git pull origin main || true
    
    - name: Check if database exists
      run: |
        # æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨
        if [ -f "thoughts.db" ]; then
          echo "æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ã¾ã™"
          mkdir -p data
          cp thoughts.db data/
          echo "æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ data/ ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"
        else
          echo "æ–°è¦ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™"
          mkdir -p data
          echo "ç©ºã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™"
          touch data/thoughts.db
        fi
        
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®çŠ¶æ…‹ã‚’ç¢ºèª
        if [ -f "data/thoughts.db" ]; then
          echo "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $(wc -c < data/thoughts.db) bytes"
          if [ -s "data/thoughts.db" ]; then
            echo "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯ç©ºã§ã¯ã‚ã‚Šã¾ã›ã‚“"
          else
            echo "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯ç©ºã§ã™"
          fi
        fi
    
    - name: Download database from cache
      run: |
        echo "ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å¾©å…ƒã—ã¾ã™..."
        # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°ä½¿ç”¨ã€ãªã‘ã‚Œã°æ—¢å­˜ã®ã¾ã¾
        if [ -f "data/thoughts.db" ]; then
          echo "æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ç¶­æŒã—ã¾ã™"
        else
          echo "ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å¾©å…ƒã—ã¾ã™"
        fi
    
    - name: Check if bot is running
      id: check_bot
      env:
        DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
        ALLOWED_CHANNEL_IDS: ${{ secrets.ALLOWED_CHANNEL_ID }}
      run: |
        # æ—¢å­˜ã®å®Ÿè¡Œä¸­ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
        RUNNING_JOBS=$(curl -s -H "Authorization: token ${{ github.token }}" \
          "https://api.github.com/repos/${{ github.repository }}/actions/runs?status=in_progress" | \
          jq -r '.workflow_runs[] | select(.id != ${{ github.run_id }}) | .id')
        
        if [ -z "$RUNNING_JOBS" ]; then
          echo "ãƒœãƒƒãƒˆãŒå®Ÿè¡Œã•ã‚Œã¦ã„ãªã„ãŸã‚ã€èµ·å‹•ã—ã¾ã™"
          echo "RUN_BOT=true" >> $GITHUB_ENV
        else
          echo "ãƒœãƒƒãƒˆã¯æ—¢ã«å®Ÿè¡Œä¸­ã§ã™"
          echo "RUN_BOT=false" >> $GITHUB_ENV
        fi
    
    - name: Run bot
      if: env.RUN_BOT == 'true'
      env:
        DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
        ALLOWED_CHANNEL_IDS: ${{ secrets.ALLOWED_CHANNEL_ID }}
      run: |
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’dataãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
        if [ -f "thoughts.db" ]; then
          mv thoughts.db data/
        fi
        
        # ãƒœãƒƒãƒˆèµ·å‹•æ™‚ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ã‚’æŒ‡å®š
        export DB_PATH="data/thoughts.db"
        
        # æ—¢å­˜ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’çµ‚äº†
        pkill -f "python.*bot.py" || true
        
        # ãƒœãƒƒãƒˆã‚’èµ·å‹•
        nohup python bot.py > bot.log 2>&1 &
        echo $! > bot.pid
        
        # èµ·å‹•ã‚’å¾…ã¤
        sleep 10
        
        # ãƒ­ã‚°ã‚’è¡¨ç¤º
        cat bot.log
        
        # ãƒ—ãƒ­ã‚»ã‚¹ãŒå®Ÿè¡Œä¸­ã‹ç¢ºèª
        if ! ps -p $(cat bot.pid) > /dev/null; then
          echo "ãƒœãƒƒãƒˆã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ"
          cat bot.log
          exit 1
        fi
        
        echo "ãƒœãƒƒãƒˆãŒæ­£å¸¸ã«èµ·å‹•ã—ã¾ã—ãŸ"
        
        # ç„¡é™ãƒ«ãƒ¼ãƒ—ã§å¾…æ©Ÿ
        while true; do
          # ãƒœãƒƒãƒˆãŒã¾ã å®Ÿè¡Œä¸­ã‹ç¢ºèª
          if ! ps -p $(cat bot.pid) > /dev/null; then
            echo "ãƒœãƒƒãƒˆãŒçµ‚äº†ã—ã¾ã—ãŸã€‚å†èµ·å‹•ã—ã¾ã™..."
            # å†èµ·å‹•
            export DB_PATH="data/thoughts.db"
            nohup python bot.py > bot.log 2>&1 &
            echo $! > bot.pid
            sleep 10
          fi
          # 1åˆ†ã”ã¨ã«ãƒã‚§ãƒƒã‚¯
          sleep 60
        done
    
    - name: Save database to cache
      if: always()
      uses: actions/cache@v3
      with:
        path: data/
        key: bot-db-main
    
    - name: Commit database changes
      if: always()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒå­˜åœ¨ã—ã€å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆ
        if [ -f "data/thoughts.db" ]; then
          # å…ƒã®å ´æ‰€ã«ã‚‚ã‚³ãƒ”ãƒ¼
          cp data/thoughts.db thoughts.db
          
          git add data/thoughts.db thoughts.db
          
          # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if ! git diff --cached --quiet; then
            git commit -m "ğŸ—„ï¸ Update database - $(date '+%Y-%m-%d %H:%M:%S')"
            git push origin main
            echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¾ã—ãŸ"
          else
            echo "â„¹ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
          fi
        fi
    
    - name: Show logs
      if: always()
      run: |
        if [ -f bot.log ]; then
          echo "=== æœ€çµ‚ãƒ­ã‚° ==="
          tail -n 50 bot.log
        fi
        if [ -f "data/thoughts.db" ]; then
          echo "=== ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ± ==="
          ls -la data/
          sqlite3 data/thoughts.db "SELECT COUNT(*) FROM thoughts;" || echo "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
        fi
