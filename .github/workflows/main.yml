name: Discord Bot

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *'  # 5分ごとにチェック

jobs:
  run-bot:
    runs-on: ubuntu-latest
    
    # 同じコミットに対して同時に複数のワークフローが実行されないようにする
    concurrency: 
      group: bot-${{ github.ref }}
      cancel-in-progress: true
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Download database from GitHub Pages
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # GitHub Pages からデータベースをダウンロード
        REPO_OWNER="${{ github.repository_owner }}"
        REPO_NAME="${{ github.event.repository.name }}"
        
        echo "データベースをダウンロードします..."
        
        # curl でデータベースをダウンロード
        if curl -f -s -L "https://${REPO_OWNER}.github.io/${REPO_NAME}/thoughts.db" -o thoughts.db; then
          echo "既存のデータベースをダウンロードしました"
          ls -la thoughts.db
        else
          echo "データベースが存在しないため、新規作成します"
        fi
    
    - name: Check if bot is running
      id: check_bot
      env:
        DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
        ALLOWED_CHANNEL_IDS: ${{ secrets.ALLOWED_CHANNEL_ID }}
      run: |
        # 既存の実行中のワークフローをチェック
        RUNNING_JOBS=$(curl -s -H "Authorization: token ${{ github.token }}" \
          "https://api.github.com/repos/${{ github.repository }}/actions/runs?status=in_progress" | \
          jq -r '.workflow_runs[] | select(.id != ${{ github.run_id }}) | .id')
        
        if [ -z "$RUNNING_JOBS" ]; then
          echo "ボットが実行されていないため、起動します"
          echo "RUN_BOT=true" >> $GITHUB_ENV
        else
          echo "ボットは既に実行中です"
          echo "RUN_BOT=false" >> $GITHUB_ENV
        fi
    
    - name: Initialize database if not exists
      if: env.RUN_BOT == 'true'
      run: |
        # データベースが存在しない場合は初期化
        if [ ! -f "thoughts.db" ]; then
          echo "データベースを初期化します"
          python scripts/init_db.py
        else
          echo "既存のデータベースを使用します"
          ls -la thoughts.db
        fi
    
    - name: Run bot
      if: env.RUN_BOT == 'true'
      env:
        DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
        ALLOWED_CHANNEL_IDS: ${{ secrets.ALLOWED_CHANNEL_ID }}
      run: |
        # 既存のプロセスを終了
        pkill -f "python.*bot.py" || true
        
        # ボットを起動
        nohup python bot.py > bot.log 2>&1 &
        echo $! > bot.pid
        
        # 起動を待つ
        sleep 10
        
        # ログを表示
        cat bot.log
        
        # プロセスが実行中か確認
        if ! ps -p $(cat bot.pid) > /dev/null; then
          echo "ボットの起動に失敗しました"
          cat bot.log
          exit 1
        fi
        
        echo "ボットが正常に起動しました"
        
        # 無限ループで待機
        while true; do
          # ボットがまだ実行中か確認
          if ! ps -p $(cat bot.pid) > /dev/null; then
            echo "ボットが終了しました。再起動します..."
            # 再起動
            nohup python bot.py > bot.log 2>&1 &
            echo $! > bot.pid
            sleep 10
          fi
          # 1分ごとにチェック
          sleep 60
        done
    
    - name: Upload database to GitHub Pages
      if: always() && env.RUN_BOT == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # GitHub Pages 用のブランチを設定
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # gh-pages ブランチを作成・チェックアウト
        git checkout --orphan gh-pages
        git rm -rf . || true
        
        # データベースをコピー
        cp thoughts.db ./
        
        # index.html を作成（GitHub Pages の要件）
        echo "<html><body><h1>Discord Bot Database</h1></body></html>" > index.html
        
        # コミットしてプッシュ
        git add .
        git commit -m "Update database - $(date)"
        git push origin gh-pages --force
        
        echo "データベースを GitHub Pages にアップロードしました"
    
    - name: Show logs
      if: always()
      run: |
        if [ -f bot.log ]; then
          echo "=== 最終ログ ==="
          tail -n 50 bot.log
        fi
